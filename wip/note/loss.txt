import os
import pandas as pd
from utils import create_driver, login, generate_urls, collect_data, get_tanggal_input

def main():
    print("ğŸš€ Memulai scraping data LOSS...")
    
    input_tanggal = get_tanggal_input()
    print(f"ğŸ“… Tanggal yang dipilih: {input_tanggal}")
    
    loss_urls = generate_urls("laporan/loss_bagian_cetak", input_tanggal)
    print(f"ğŸ”— Generated {len(loss_urls)} URLs")

    driver = create_driver()

    try:
        # Login
        login(driver)
        
        # Collect data
        loss_data = collect_data(driver, loss_urls, "LOSS", add_bagian_column=False)
        
        print(f"\nğŸ“Š Data yang terkumpul: {len(loss_data)} baris")
        
        if not loss_data:
            print("âŒ Tidak ada data yang berhasil dikumpulkan!")
            print("ğŸ” Kemungkinan penyebab:")
            print("  - Selector CSS tidak cocok dengan struktur HTML")
            print("  - Tanggal tidak memiliki data")
            print("  - Halaman web berubah struktur")
            print("  - Koneksi timeout")
            return

        # Buat direktori data
        os.makedirs("data", exist_ok=True)
        
        # Simpan ke Excel
        df_loss = pd.DataFrame(loss_data)
        filename = f"data/loss-bagian-{input_tanggal}.xlsx"
        
        # Simpan dengan header untuk debugging
        if len(loss_data) > 0:
            # Cek struktur data
            print(f"ğŸ“‹ Struktur data pertama: {loss_data[0]}")
            print(f"ğŸ“ Jumlah kolom: {len(loss_data[0]) if loss_data else 0}")
            
            # Preview beberapa baris data
            print("ğŸ“ Preview data LOSS (3 baris pertama):")
            for i, row in enumerate(loss_data[:3]):
                print(f"  Baris {i+1}: {row}")
            
            print("ğŸ’¡ Struktur kolom LOSS:")
            print("  Data langsung dari tabel tanpa kolom bagian tambahan")
            
            # Simpan dengan header untuk memudahkan debugging
            df_loss.to_excel(filename, index=False, header=False)
            
            # Verifikasi file
            if os.path.exists(filename):
                file_size = os.path.getsize(filename)
                print(f"âœ… Data LOSS berhasil disimpan di '{filename}'")
                print(f"ğŸ“ Ukuran file: {file_size} bytes")
                
                # Test baca kembali file
                df_test = pd.read_excel(filename, header=None)
                print(f"âœ… Verifikasi: File berisi {len(df_test)} baris")
            else:
                print(f"âŒ File tidak berhasil dibuat: {filename}")
        else:
            print("âŒ Data kosong, file tidak dibuat")

    except Exception as e:
        print(f"âŒ Terjadi kesalahan: {e}")
        import traceback
        traceback.print_exc()

    finally:
        # Catatan: Browser tidak ditutup untuk pemeriksaan manual
        print("\nğŸŸ¢ Browser tetap terbuka untuk pemeriksaan manual.")
        print("ğŸ’¡ Tips debugging:")
        print("  1. Cek apakah halaman web berisi tabel data")
        print("  2. Inspect element untuk melihat struktur HTML tabel")
        print("  3. Pastikan tanggal memiliki data")
        print("  4. Cek console browser untuk error JavaScript")

if __name__ == "__main__":
    main()